 <h2 mat-dialog-title>Modifier votre Photo / Emoji de profil</h2>
    <mat-dialog-content>
      <mat-tab-group>
        <!-- Onglet Emoji -->
        <mat-tab label="Emoji">
          <div class="p-4">
            <h3 class="mb-4">Choisir un emoji :</h3>
            <div class="emoji-grid">
              @for (emoji of availableEmojis; track emoji) {
                <button
                  mat-button
                  class="emoji-button"
                  [class.selected]="selectedPhoto() === emoji"
                  (click)="selectPhoto(emoji)"
                >
                  {{ emoji }}
                </button>
              }
            </div>
          </div>
        </mat-tab>

        <!-- Onglet Upload -->
        <mat-tab label="Upload">
          <div class="p-4">
            <h3 class="mb-4">T√©l√©charger une image :</h3>

            <!-- Zone de drop/s√©lection -->
            <div class="upload-area"
                [class.dragover]="isDragOver()"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDrop($event)"
                (click)="fileInput.click()"
                tabindex="0"
                role="button"
                (keydown.enter)="fileInput.click()"
                (keydown.space)="fileInput.click()">
              <div class="upload-content">
                @if (!selectedFile()) {
                  <div class="text-center">
                    <mat-icon class="upload-icon">cloud_upload</mat-icon>
                    <p class="mb-2">Cliquez ou glissez une image ici</p>
                    <p class="text-sm text-gray-500">
                      Formats accept√©s: JPEG, PNG, GIF, WebP (max 5MB)
                    </p>
                  </div>
                } @else {
                  <div class="text-center">
                    <p class="mb-2">üìÅ {{ selectedFile()?.name }}</p>
                    <p class="text-sm text-gray-500">
                      {{ formatFileSize(selectedFile()?.size || 0) }}
                    </p>
                    <button mat-button color="warn" (click)="clearSelectedFile($event)">
                      Supprimer
                    </button>
                  </div>
                }
              </div>
            </div>

            <!-- Input file cach√© -->
            <input
              #fileInput
              type="file"
              accept="image/*"
              style="display: none"
              (change)="onFileSelected($event)"
            />

            <!-- Aper√ßu de l'upload -->
            @if (previewUrl()) {
              <div class="mt-4">
                <h4>Aper√ßu :</h4>
                <lib-user-avatar
                  [photoUrl]="previewUrl()"
                  cssClass="w-[80px] h-[80px] rounded-full"
                  alt="Aper√ßu de l'upload"
                />
              </div>
            }

            <!-- Bouton d'upload -->
            @if (selectedFile() && !uploading()) {
              <button
                mat-raised-button
                color="accent"
                class="mt-4 w-full"
                (click)="uploadFile()"
                [disabled]="uploading()"
              >
                T√©l√©charger l'image
              </button>
            }

            @if (uploading()) {
              <div class="mt-4 text-center">
                <mat-progress-spinner
                  diameter="40"
                  mode="indeterminate">
                </mat-progress-spinner>
                <p class="mt-2">Upload en cours...</p>
              </div>
            }
          </div>
        </mat-tab>

        <!-- Onglet Base64 (stockage en DB) -->
        <mat-tab label="Base64 DB">
          <div class="p-4">
            <h3 class="mb-4">Stocker l'image en base de donn√©es :</h3>
            <p class="text-sm text-gray-600 mb-4">
              L'image sera convertie en base64 et stock√©e directement en base.
            </p>

            <!-- Zone de drop/s√©lection pour base64 -->
            <div class="upload-area"
                [class.dragover]="isDragOver()"
                (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)"
                (drop)="onDropBase64($event)"
                (click)="fileInputBase64.click()"
                tabindex="0"
                role="button"
                (keydown.enter)="fileInputBase64.click()"
                (keydown.space)="fileInputBase64.click()">
              <div class="upload-content">
                @if (!selectedFileBase64()) {
                  <div class="text-center">
                    <mat-icon class="upload-icon">storage</mat-icon>
                    <p class="mb-2">Cliquez ou glissez une image ici</p>
                    <p class="text-sm text-gray-500">
                      L'image sera stock√©e en base64 dans la base de donn√©es
                    </p>
                  </div>
                } @else {
                  <div class="text-center">
                    <p class="mb-2">üìÅ {{ selectedFileBase64()?.name }}</p>
                    <p class="text-sm text-gray-500">
                      {{ formatFileSize(selectedFileBase64()?.size || 0) }}
                    </p>
                    @if (base64Preview()) {
                      <div class="mt-2">
                        <lib-user-avatar
                          [photoUrl]="base64Preview()"
                          cssClass="w-[60px] h-[60px] rounded-full mx-auto"
                          alt="Aper√ßu base64"
                        />
                      </div>
                    }
                    <button mat-button color="warn" (click)="clearSelectedFileBase64($event)">
                      Supprimer
                    </button>
                  </div>
                }
              </div>
            </div>

            <!-- Input file cach√© pour base64 -->
            <input
              #fileInputBase64
              type="file"
              accept="image/*"
              (change)="onFileSelectedBase64($event)"
              style="display: none"
            />

            @if (isUploadingBase64()) {
              <div class="text-center mt-4">
                <mat-progress-spinner
                  diameter="40"
                  mode="indeterminate">
                </mat-progress-spinner>
                <p class="mt-2">Upload en cours...</p>
              </div>
            }
          </div>
        </mat-tab>

        <!-- Onglet URL d'image -->
        <mat-tab label="Image URL">
          <div class="p-4">
            <mat-form-field class="w-full">
              <mat-label>URL de l'image</mat-label>
              <input
                matInput
                type="url"
                [(ngModel)]="imageUrl"
                placeholder="https://example.com/image.jpg"
                (input)="onImageUrlChange()"
              />
            </mat-form-field>

            @if (imageUrl()) {
              <div class="mt-4">
                <h4>Aper√ßu :</h4>
                <lib-user-avatar
                  [photoUrl]="imageUrl()"
                  cssClass="w-[80px] h-[80px] rounded-full"
                  alt="Aper√ßu de l'image"
                />
              </div>
            }
          </div>
        </mat-tab>
      </mat-tab-group>

      <!-- Aper√ßu s√©lectionn√© -->
      @if (selectedPhoto()) {
        <div class="mt-4 text-center">
          <h4>Aper√ßu s√©lectionn√© :</h4>
          <p class="text-sm text-gray-600 mb-2">Valeur: "{{ selectedPhoto() }}"</p>
          <lib-user-avatar
            [photoUrl]="selectedPhoto()"
            cssClass="w-[100px] h-[100px] rounded-full mx-auto"
            alt="Aper√ßu s√©lectionn√©"
          />
        </div>
      } @else {
        <div class="mt-4 text-center text-gray-500">
          <p>Aucune photo s√©lectionn√©e</p>
        </div>
      }
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-button (click)="cancel()">Annuler</button>
      <button
        mat-raised-button
        color="primary"
        [disabled]="!selectedPhoto() || saving()"
        (click)="save()"
      >
        {{ saving() ? 'Enregistrement...' : 'Enregistrer' }}
      </button>
    </mat-dialog-actions>
